<html>
  <head>
  	<title>Deprive Me - Absence makes the heart grow fonder</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  	<script type="text/javascript" src="./underscore-min.js"></script>
    <script type="text/javascript">
		var clientId = '839550991886';
		var apiKey = 'AIzaSyD6jfPPmLp0zruUdCy2HA4XopM_HO7j4kU';
		var scopes = 'https://www.googleapis.com/auth/calendar';

		var depriveCal = null;

		function handleClientLoad(){
			gapi.client.setApiKey(apiKey);
		}

		function handleAuthResult(authResult) {
			if (authResult) {
				$('#submit').prop('disabled', true);
			  	makeApiCall();

			} else {
				alert('Something went wrong, please try again');
			}
			  	$('#submit').prop('disabled', false);
		}

		function makeApiCall() {
			gapi.client.load('calendar', 'v3', function() {
			  	var request = gapi.client.calendar.calendarList.list();
			  	request.execute(function(res) {
		    		if (!res)
						return alert("error");

					depriveCal = _.find(res.items, function(item){ return item.summary == 'DepriveMe'; });

					if(depriveCal){
						alert("Found calendar");
						addEntries();
					}
					else{
						createCalendar()
					}
		  		});
			});
		}

		function addEntries(){
			var data = getFormData();
			alert("adding entries");

			var params = {
				"calendarId" : depriveCal.id,
				"resource": 
				{
					"summary": "Test Entry",
					"start": {"date": "2012-02-27"},
					"end": {"date": "2012-02-27"}
				}
			};

			var req = gapi.client.calendar.events.insert(params);

			req.execute(function(res){
				if (res)
					alert("done");
				else
					alert("error");
			})
		}

		function createCalendar(){
			alert("Creating calendar");
			var req = gapi.client.calendar.calendars.insert(
				{"resource":
					{
					 	"summary": "DepriveMe",
					 	"description": "Generated by depriveme.apphb.com",
					 	"timezone" : "Australia/Sydney"
					}
				});

			req.execute(function(res){
				if (!res)
					return alert("error");

				depriveCal = res.result;
				addEntries();

			});
		}

		function addRow(val){
			var rowHtml = '<tr> \
  					<td><input type="text" class="item" value="' + (val || "") + '" /></td> \
  					<td> \
  						<input type="checkbox" checked="true" class="sun">S</input> \
  						<input type="checkbox" checked="true" class="mon">M</input> \
  						<input type="checkbox" checked="true" class="tue">T</input> \
  						<input type="checkbox" checked="true" class="wed">W</input> \
  						<input type="checkbox" checked="true" class="thu">T</input> \
  						<input type="checkbox" checked="true" class="fri">F</input> \
  						<input type="checkbox" checked="true" class="sat">S</input> \
  					</td> \
  				</tr>';

			$('#items tbody:last').append(rowHtml);

		}

		function getFormData(){
			var values = {};
			$.each($('#data').serializeArray(), function(i, field) {
			    values[field.name] = field.value;
			});

			return values;
		}

		$(document).ready(function(){
			$('#huh').hide();

			addRow('Internet');
			addRow('Food');
			addRow('Hot Showers');

			$('#showHuh').click(function(e){
				e.preventDefault();
				$('#huh').show();
			});


			$('#hideHuh').click(function(e){
				e.preventDefault();
				$('#huh').hide();
			});

			$('#data').submit(function(e){
				e.preventDefault();
				gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: false}, handleAuthResult);
			});
		});
    </script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>

  </head>

  <body>
  	<div id="title">
  		<h2>Deprive Me</h2>
  		<h4>Absence makes the heart grow fonder</h4>
  		<a href="#" id="showHuh">Huh?</a>
  	</div>
  	<form id="data">
  		Over next next <input type="text" id="numberOfDats"/> days, randomly deprive me of:
  		<br/>
  		<table id="items">
  			<thead>
  				<th></th>
  				<th></th>
  			</thead>
  			<tbody>
  			</tbody>
  		</table>
  		<button onclick="addRow()">+</button>
    	<!-- <button onclick="handleAuthClick();" id="auth">Add Events</button> -->
    	<input id="submit" type="submit" value="Add to Google Calendar" />
   	</form>
    <div id="huh">
    	For a while I've been experimenting with taking a 24hr break from the things in my life that I enjoy or 
		depend on. I've found that it is a great way to increase my appreciation of what I have. Plus it help me 
		become less attached to material things.
    	<br /><br />
		DepriveMe is a simple tool I wrote to help me keep this organised. Randomising it makes it a bit more fun, too. 
		It works like this:
		<ul>
			<li>If it doesn't already exist, a 'DepriveMe' calendar is created in your Google Calandar</li>
			<li>You enter a list of things you'd like to take a scheduled break from. My list includes: coffee; food;
				hot showers; my smartphone and music</li>
			<li>You choose which days you are OK for each item. For example, I can only deprive myself of the Intener
				on the weekend, as I need it for work.</li>
			<li>You specify how long a period you want the list spread across</li>
			<li>DepriveMe randomly, but somewhat evenly distributes new events each item across the time period</li>
		</ul>
		<a href="#" id="hideHuh">Hide</a>
    </div>
  </body>
</html>
