var clientId = '839550991886';
var apiKey = 'AIzaSyD6jfPPmLp0zruUdCy2HA4XopM_HO7j4kU';
var scopes = 'https://www.googleapis.com/auth/calendar';

var depriveCal = null;

function handleClientLoad(){
	gapi.client.setApiKey(apiKey);
}

function handleAuthResult(authResult) {
	if (authResult) {
		$('#submit').prop('disabled', true);
	  	getCalendar();

	} else {
		alert('Something went wrong, please try again');
	}
	  	$('#submit').prop('disabled', false);
}

function getCalendar() {
	gapi.client.load('calendar', 'v3', function() {
	  	var request = gapi.client.calendar.calendarList.list();
	  	request.execute(function(res) {
    		if (!res)
				return alert("error");

			depriveCal = _.find(res.items, function(item){ return item.summary == 'DepriveMe'; });

			if(depriveCal)
				addEntries();
			else
				createCalendar()
  		});
	});
}

function addEntries(){
	var data = getFormData();

	for (var i in data.items) {
		var offset = Math.floor(Math.random()*(parseInt(data.days)+1));

		var date = new Date();
		date.setDate(date.getDate() + offset);

		var dateString = date.getFullYear() + '-' + (parseInt(date.getMonth())+1) + '-' + date.getDate();

		var params = {
			"calendarId" : depriveCal.id,
			"resource": 
			{
				"summary": data.items[i],
				"start": {"date": dateString},
				"end": {"date": dateString}
			}
		};
	
		var req = gapi.client.calendar.events.insert(params);

		req.execute(function(){return null;});

	};
}

function createCalendar(){
	alert("Creating calendar");
	var req = gapi.client.calendar.calendars.insert(
		{"resource":
			{
			 	"summary": "DepriveMe",
			 	"description": "Generated by depriveme.apphb.com",
			 	"timezone" : "Australia/Sydney"
			}
		});

	req.execute(function(res){
		if (!res)
			return alert("error");

		depriveCal = res.result;
		addEntries();

	});
}

function addRow(val){
	var rowHtml = '\
			<tr> \
				<td> \
					<input type="text" class="item" value="' + (val || "") + '" /> \
					</td> \
			</tr>';

	$('#items tbody:last').append(rowHtml);

}

function getFormData(){
	// var data = $('#data').serializeArray();
	// return _.map(data, function(val) { return val.value; }); 
	var data = {};
	data.days = $('#days').val();
	data.items = []

	$('.item').each(function(i){
		data.items.push(this.value);
	});

	return data;
}
